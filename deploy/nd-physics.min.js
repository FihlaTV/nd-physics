var NDP={};Object.defineProperty(NDP,"VERSION",{value:"0.1.0"}),NDP.__DIMENSIONS=2,Object.defineProperty(NDP,"DIMENSIONS",{set:function(a){NDP.__DIMENSIONS=Math.clamp(parseInt(a,10),1,3)},get:function(){return NDP.__DIMENSIONS}}),NDP.__THRESHOLD=1e-6,Object.defineProperty(NDP,"THRESHOLD",{set:function(a){NDP.__THRESHOLD=Math.clamp(parseFloat(a,10),1e-6,.1)},get:function(){return NDP.__THRESHOLD}}),Object.defineProperty(NDP,"COMPONENTS",{value:["x","y","z"]}),NDP.isType=function(a,b){return b===String?"string"==typeof a||a instanceof String:b===Number?"number"==typeof a||a instanceof Number:b===Function?"function"==typeof a||a instanceof Function:b===Object?"object"==typeof a:b===Boolean?"boolean"==typeof a:a instanceof b},NDP.isBoolean=function(a){return NDP.isType(a,Boolean)},NDP.isNumber=function(a){return NDP.isType(a,Number)},NDP.isArray=function(a){return NDP.isType(a,NDP.Array)},NDP.getTime=function(){return NDP.Timer.now()},NDP.getVector=function(a){return NDP["Vector"+a]},NDP.getAxes=function(a){var b,c,d,e={length:0,axes:[]};if(a)for(b=0;a>b;b++)for(c=0;a>c;c++)b!==c&&(d=NDP.COMPONENTS[b]+NDP.COMPONENTS[c],sum=(b+1)*(c+1),e[sum]||(e.axes.push(e[sum]=[b,c]),e.length++));return e},NDP.addItemToArray=function(a,b,c){var d=b.indexOf(a),e=-1===d;return e&&void 0!==c&&(e=NDP.isType(a,c)),e&&b.push(a),e},NDP.removeItemFromArray=function(a,b){var c=b.indexOf(a),d=-1!==c;return d&&b.splice(c,1),d},NDP.copyValuesToArray=function(a,b,c){c=this.isBoolean(c)?c:!0;for(var d=0,e=a.length;e>d;d++)if(c){if(!(d<b.length))break;b[d]=a[d]}else b[d]=a[d]},NDP.Array=window.Float32Array?window.Float32Array:Array,NDP.Timer=window.performance?window.performance:Date,NDP.Engine=function(a,b){this.__buffer=0,this.__delta=null,this.__time=null,this.physical=NDP.isBoolean(b)?b:!1,this.lubricity=.999,this.timeStep=1/60,this.maxSteps=4,this.integrator=NDP.isType(a,NDP.Integrator)?a:new NDP.EulerIntegrator,this.particles=[],this.springs=[]},Object.defineProperty(NDP.Engine.prototype,"physical",{set:function(a){NDP.isBoolean(a)&&(this.__physical=a)},get:function(){return this.__physical}}),Object.defineProperty(NDP.Engine.prototype,"lubricity",{set:function(a){NDP.isNumber(a)&&(this.__lubricity=Math.clamp(a,1e-6,.999999))},get:function(){return this.__lubricity}}),Object.defineProperty(NDP.Engine.prototype,"timeStep",{set:function(a){NDP.isNumber(a)&&(this.__timeStep=a)},get:function(){return this.__timeStep}}),Object.defineProperty(NDP.Engine.prototype,"maxSteps",{set:function(a){NDP.isNumber(a)&&(this.__maxSteps=Math.clamp(Math.floor(a),1,10))},get:function(){return this.__maxSteps}}),NDP.Engine.prototype.addParticle=function(a){return NDP.addItemToArray(a,this.particles,NDP.Particle),this},NDP.Engine.prototype.removeParticle=function(a){return NDP.removeItemFromArray(a,this.particles),this},NDP.Engine.prototype.addSpring=function(a){return NDP.addItemToArray(a,this.springs,NDP.Spring),this},NDP.Engine.prototype.removeSpring=function(a){return NDP.removeItemFromArray(a,this.springs),this},NDP.Engine.prototype.step=function(a){this.__time||(this.__time=NDP.getTime());var b=0,c=a||NDP.getTime(),d=c-this.__time;if(0>=d)return this;if(this.__delta=.001*d,this.__time=c,this.__buffer+=this.__delta,this.__physical)for(;this.__buffer>=this.__timeStep&&++b<=this.__maxSteps;)this.integrate(this.__timeStep),this.__buffer-=this.__timeStep;else this.integrate(this.__delta);return this},NDP.Engine.prototype.integrate=function(a){if(!a||!this.particles.length)return this;for(var b=0,c=this.particles.length;c>b;b++)this.particles[b].update(a,b);this.integrator.integrate(this.particles,a,this.__lubricity);for(var d=0,e=this.springs.length;e>d;d++)this.springs[d].update(a,d);return this},NDP.Particle=function(a,b,c,d){if(!NDP.isNumber(a))throw"Particle: mass must be a Number ["+a+"]";if(Object.defineProperty(this,"dimensions",{value:NDP.isNumber(d)?parseInt(d,10):NDP.DIMENSIONS}),this.__dimensions=this.dimensions,this.__vector=NDP.getVector(this.__dimensions),!this.__vector)throw"Particle: No Vector Object available for ["+this.__dimensions+"] dimensions";this.mass=a,this.radius=NDP.isNumber(b)?b:a,this.fixed=NDP.isBoolean(c)?c:!1,this.behaviours=[],Object.defineProperty(this,"id",{value:this.constructor.__uid++}),this.__acc=this.__vector.create(),this.__vel=this.__vector.create(),this.__pos=this.__vector.create(),this.__old={acc:this.__vector.create(),vel:this.__vector.create(),pos:this.__vector.create()};for(var e=0;e<this.__dimensions;e++)this.__defineComponent(e,"acc","a"),this.__defineComponent(e,"vel","v"),this.__defineComponent(e,"pos")},NDP.Particle.__uid=0,NDP.Particle.prototype.__defineComponent=function(a,b,c){var d="string"==typeof c?c:"",e=d+NDP.COMPONENTS[a],f="__"+e,g="__"+b;this[f]=this[g][a],Object.defineProperty(this,e,{set:function(c){NDP.isNumber(c)&&(this[f]=c,this[g][a]=c,this.__old[b][a]=c)},get:function(){return this[f]}})},Object.defineProperty(NDP.Particle.prototype,"mass",{set:function(a){NDP.isNumber(a)&&(this.__mass=a,this.__inverseMass=1/a)},get:function(){return this.__mass}}),Object.defineProperty(NDP.Particle.prototype,"radius",{set:function(a){NDP.isNumber(a)&&(this.__radius=a,this.__radiusSquared=a*a)},get:function(){return this.__radius}}),Object.defineProperty(NDP.Particle.prototype,"fixed",{set:function(a){NDP.isBoolean(a)&&(this.__fixed=a)},get:function(){return this.__fixed}}),NDP.Particle.prototype.addBehaviour=function(a){if(NDP.addItemToArray(a,this.behaviours,NDP.Behaviour))switch(a.constructor.id){case NDP.CollisionBehaviour.id:a.addParticle(this)}return this},NDP.Particle.prototype.removeBehaviour=function(a){if(NDP.removeItemFromArray(a,this.behaviours))switch(a.constructor.id){case NDP.CollisionBehaviour.id:a.removeParticle(this)}return this},NDP.Particle.prototype.update=function(a,b){var c,d,e,f;if(!this.__fixed&&0!==a)for(c=0,d=this.behaviours.length;d>c;c++)e=this.behaviours[c],e.active&&e.apply(this,a,b);for(c=0,d=this.__dimensions;d>c;c++)f=NDP.COMPONENTS[c],this["__a"+f]=this.__acc[c],this["__v"+f]=this.__vel[c],this["__"+f]=this.__pos[c];return this},NDP.Spring=function(a,b,c,d){if(!NDP.isType(a,NDP.Particle))throw"Spring: p1 must be a Particle instance ["+a+"]";if(!NDP.isType(b,NDP.Particle))throw"Spring: p2 must be a Particle instance ["+b+"]";if(a===b)throw"Spring: p1 and p2 cannot be the same Particle instance";if(a.dimensions!==b.dimensions)throw"Spring: Particles must have equal dimensions. p1.dimensions["+a.dimensions+"] p2.dimensions["+b.dimensions+"]";if(!NDP.isNumber(c))throw"Spring: length must be a Number ["+c+"]";if(!NDP.isNumber(d))throw"Spring: stiffness must be a Number ["+d+"]";Object.defineProperty(this,"id",{value:this.constructor.__uid++}),this.p1=a,this.p2=b,this.length=c,this.stiffness=d,this.__vector=a.__vector,this.__delta=this.__vector.create(),this.__slave=this.__vector.create()},NDP.Spring.__uid=0,Object.defineProperty(NDP.Spring.prototype,"p1",{set:function(a){NDP.isType(a,NDP.Particle)&&(this.__p1=a)},get:function(){return this.__p1}}),Object.defineProperty(NDP.Spring.prototype,"p2",{set:function(a){NDP.isType(a,NDP.Particle)&&(this.__p2=a)},get:function(){return this.__p2}}),Object.defineProperty(NDP.Spring.prototype,"length",{set:function(a){NDP.isNumber(a)&&(this.__length=a)},get:function(){return this.__length}}),Object.defineProperty(NDP.Spring.prototype,"stiffness",{set:function(a){NDP.isNumber(a)&&(this.__stiffness=a)},get:function(){return this.__stiffness}}),NDP.Spring.prototype.update=function(){this.__vector.subtract(this.__delta,this.__p2.__pos,this.__p1.__pos);var a=NDP.__THRESHOLD+this.__vector.length(this.__delta),b=this.__p1.__inverseMass+this.__p2.__inverseMass,c=(a-this.__length)/(a*b)*this.__stiffness;return this.apply(this.__p1,c),this.apply(this.__p2,-c),this},NDP.Spring.prototype.apply=function(a,b){return a.__fixed||(this.__vector.scale(this.__slave,this.__delta,a.__inverseMass*b),this.__vector.add(a.__pos,a.__pos,this.__slave)),this},Object.defineProperty(Math,"PI2",{value:2*Math.PI}),Object.defineProperty(Math,"PIH",{value:Math.PI/2}),Math.normalize=function(a,b,c){return b=NDP.isNumber(b)?b:0,c=NDP.isNumber(c)?c:1,(a-b)/(c-b)},Math.interpolate=function(a,b,c){return b+(c-b)*a},Math.map=function(a,b,c,d,e){return Math.interpolate(Math.normalize(a,b,c),d,e)},Math.clamp=function(a,b,c){return a=Math.max(a,b),a=Math.min(a,c)},Math.sign=function(a){return a>=0?1:-1},Math.randomInRange=function(a,b,c){return c=NDP.isBoolean(c)?c:!1,value=Math.map(Math.random(),0,1,a,b),c&&(value=Math.round(value)),value},Math.randomSign=function(a){return a=NDP.isNumber(a)?a:.5,Math.random()<a?1:-1},Math.randomBoolean=function(a){return a=NDP.isNumber(a)?a:.5,Math.random()<a},Math.randomItem=function(a){return a[Math.floor(Math.random()*(a.length-1e-6))]},NDP.Vector1={},NDP.Vector1.create=function(a){var b=new NDP.Array(1);return b[0]=NDP.isNumber(a)?a:0,b},NDP.Vector1.identity=function(a){return a[0]=0,a},NDP.Vector1.set=function(a,b){return a[0]=b,a},NDP.Vector1.copy=function(a,b){return a[0]=b[0],a},NDP.Vector1.add=function(a,b,c){return a[0]=b[0]+c[0],a},NDP.Vector1.subtract=function(a,b,c){return a[0]=b[0]-c[0],a},NDP.Vector1.scale=function(a,b,c){return a[0]=b[0]*c,a},NDP.Vector1.squaredLength=function(a){var b=a[0];return b*b},NDP.Vector1.length=function(a){return Math.abs(a[0])},NDP.Vector1.normalize=function(a,b,c){c=c||1;var d=NDP.Vector1.length(b);return d>0?(d=c/d,NDP.Vector1.scale(a,b,d)):NDP.Vector1.identity(a),a},NDP.Vector2={},NDP.Vector2.create=function(a,b){var c=new NDP.Array(2);return c[0]=NDP.isNumber(a)?a:0,c[1]=NDP.isNumber(b)?b:0,c},NDP.Vector2.identity=function(a){return a[0]=0,a[1]=0,a},NDP.Vector2.set=function(a,b,c){return a[0]=b,a[1]=c,a},NDP.Vector2.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},NDP.Vector2.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a},NDP.Vector2.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},NDP.Vector2.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},NDP.Vector2.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},NDP.Vector2.length=function(a){return Math.sqrt(NDP.Vector2.squaredLength(a))},NDP.Vector2.normalize=function(a,b,c){c=c||1;var d=NDP.Vector2.squaredLength(b);return d>0?(d=c/Math.sqrt(d),NDP.Vector2.scale(a,b,d)):NDP.Vector2.identity(a),a},NDP.Vector3={},NDP.Vector3.create=function(a,b,c){var d=new NDP.Array(3);return d[0]=NDP.isNumber(a)?a:0,d[1]=NDP.isNumber(b)?b:0,d[2]=NDP.isNumber(c)?c:0,d},NDP.Vector3.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a},NDP.Vector3.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},NDP.Vector3.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},NDP.Vector3.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},NDP.Vector3.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},NDP.Vector3.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},NDP.Vector3.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},NDP.Vector3.length=function(a){return Math.sqrt(NDP.Vector3.squaredLength(a))},NDP.Vector3.normalize=function(a,b,c){c=c||1;var d=NDP.Vector3.squaredLength(b);return d>0?(d=c/Math.sqrt(d),NDP.Vector3.scale(a,b,d)):NDP.Vector3.identity(a),a},NDP.Integrator=function(a){if(Object.defineProperty(this,"dimensions",{value:NDP.isNumber(a)?parseInt(a,10):NDP.DIMENSIONS}),this.__dimensions=this.dimensions,this.__vector=NDP.getVector(this.__dimensions),!this.__vector)throw"Integrator: No Vector Object available for ["+this.__dimensions+"] dimensions";this.__acc=this.__vector.create(),this.__vel=this.__vector.create(),this.__pos=this.__vector.create()},NDP.Integrator.prototype.integrate=function(a,b,c){var d,e,f;for(d=0,e=a.length;e>d;d++)f=a[d],f.__fixed||this.__integrate(f,b,c)},NDP.Integrator.prototype.__integrate=function(a){this.__vector.copy(a.__pos,a.__pos)},NDP.Integrator.create=function(a,b){if(NDP[a])throw"Integrator: Object already defined for NDP["+a+"]";var c=NDP[a]=function(){NDP.Integrator.call(this)};return c.prototype=Object.create(NDP.Integrator.prototype),c.prototype.constructor=c,c.prototype.__integrate=b,c},NDP.Integrator.create("EulerIntegrator",function(a,b,c){this.__vector.scale(a.__acc,a.__acc,a.__inverseMass*b),this.__vector.add(a.__vel,a.__vel,a.__acc),this.__vector.scale(a.__vel,a.__vel,c),this.__vector.scale(this.__vel,a.__vel,b),this.__vector.add(a.__pos,a.__pos,this.__vel),this.__vector.identity(a.__acc)}),NDP.Integrator.create("ImprovedEulerIntegrator",function(a,b,c){this.__vector.scale(this.__acc,a.__acc,a.__inverseMass*b*b*.5),this.__vector.scale(this.__vel,a.__vel,b),this.__vector.add(this.__vel,this.__vel,this.__acc),this.__vector.add(a.__pos,a.__pos,this.__vel),this.__vector.scale(a.__acc,a.__acc,b),this.__vector.add(a.__vel,a.__vel,a.__acc),this.__vector.scale(a.__vel,a.__vel,c),this.__vector.identity(a.__acc)}),NDP.Integrator.create("VerletIntegrator",function(a,b,c){this.__vector.subtract(a.__vel,a.__pos,a.__old.pos),this.__vector.scale(a.__vel,a.__vel,c),this.__vector.scale(a.__acc,a.__acc,b*b),this.__vector.add(a.__vel,a.__vel,a.__acc),this.__vector.copy(a.__old.pos,a.__pos),this.__vector.add(a.__pos,a.__pos,a.__vel),this.__vector.identity(a.__acc)}),NDP.Behaviour=function(a){if(Object.defineProperty(this,"dimensions",{value:NDP.isNumber(a)?parseInt(a,10):NDP.DIMENSIONS}),this.__dimensions=this.dimensions,this.__vector=NDP.getVector(this.__dimensions),!this.__vector)throw"Behaviour: No Vector Object available for ["+this.__dimensions+"] dimensions";this.active=!0},NDP.Behaviour.id="Behaviour",NDP.Behaviour.prototype.apply=function(){},NDP.Behaviour.create=function(a){if(NDP[a])throw"Behaviour: Object already defined for NDP["+a+"]";var b=NDP[a]=function(){NDP.Behaviour.call(this)};return b.prototype=Object.create(NDP.Behaviour.prototype),b.prototype.constructor=b,b},NDP.CollisionBehaviour=function(){NDP.Behaviour.call(this)},NDP.CollisionBehaviour.id="CollisionBehaviour",NDP.CollisionBehaviour.prototype=Object.create(NDP.Behaviour.prototype),NDP.CollisionBehaviour.prototype.constructor=NDP.CollisionBehaviour,NDP.CollisionBehaviour.prototype.addParticle=function(){},NDP.CollisionBehaviour.prototype.removeParticle=function(){},NDP.ConstantBehaviour=function(){NDP.Behaviour.call(this)},NDP.ConstantBehaviour.id="ConstantBehaviour",NDP.ConstantBehaviour.prototype=Object.create(NDP.Behaviour.prototype),NDP.ConstantBehaviour.prototype.constructor=NDP.ConstantBehaviour;